<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        #rectangle {
            position: relative; /* 子要素を絶対位置指定できるように */
            width: 400px; /* 親要素の幅 */
            height: 400px; /* 親要素の高さ */
        }

        .square {
            position: absolute; /* 絶対位置指定 */
            background-color: blue; /* 四角形の色 */
        }

        .line {
            position: absolute; /* 絶対位置指定 */
            border: 1px solid red; /* 線の色 */
            transform-origin: 0 0; /* 回転の基点を始点に設定 */
        }
    </style>
</head>
<body>
    <button onclick="adder();">add box</button>
    <!-- <button onclick="displayer();">piyo</button>
    <button onclick="updater();">fuga</button> -->

    <input type="text" id="inputField" placeholder="値が表示されます" />
    <button id="applyButton" onclick="applyer();">apply</button>
    <div id="container"></div>
    <div id="rectangle"></div>
</body>
<script>
    let array = [
        { name: "Alice", age: 25, city: "New York" },
        { name: "Bob", age: 30, city: "Los Angeles" },
        { name: "Charlie", age: 35, city: "Chicago" }
    ];
    console.log(array[0]["name"]);

    let boxes = []
    let box_num = 0;

    const container = document.getElementById("container");
    const inputField = document.getElementById("inputField");
    const applyButton = document.getElementById("applyButton");

    let lastClickedKey = null; // 直前にクリックしたプロパティ名を保持
    let lastClickedIndex = null; // 直前にクリックしたインデックスを保持

    let update_add = [];
    let update_delete = [];

    function adder() {
        boxes.push({ 
            id: box_num.toString(),
            name: "box"+box_num,
            predecessor: "",
            successor: ""
        })
        box_num += 1;
        // console.log(boxes);
        displayer();
    }

    function displayer() {
        // containerをリセット
        container.innerHTML = '';

        // 配列の内容をリスト形式で表示
        boxes.forEach((item, index) => {
            const li = document.createElement("li");

            Object.entries(item).forEach(([key, value]) => {
                const button = document.createElement("button");
                button.textContent = key; // プロパティ名をボタンに設定
                button.id = `button-${index}-${key}`; // 固有のIDを割り振り
                
                // ボタンをクリックしたときの処理
                button.onclick = () => {
                    inputField.value = value; // 入力欄に値を設定
                    lastClickedKey = key; // 直前のキーを保存
                    lastClickedIndex = index; // 直前のインデックスを保存
                    // console.log(lastClickedKey);
                    // console.log(lastClickedIndex);
                };

                li.appendChild(button); // ボタンをリスト項目に追加
                li.appendChild(document.createTextNode(`: ${value}`)); // 値をテキストとして追加
            });

            container.appendChild(li); // <div>に<li>を追加
        });

        diagram_displayer();
    }

    function reseter() {
        const container = document.getElementById("container");

        // containerをリセット
        container.innerHTML = '';
    }

    // 適用ボタンをクリックしたときの処理
    function applyer() {
        update_detector();
        // console.log(lastClickedKey);
        // console.log(lastClickedIndex);
        if (lastClickedKey !== null && lastClickedIndex !== null) {
            boxes[lastClickedIndex][lastClickedKey] = inputField.value; // 配列の値を更新
            // console.log(`Updated ${lastClickedKey} to ${inputField.value}`); // 更新したことを通知
        }
        if (lastClickedKey === "predecessor" ||  lastClickedKey === "successor"){
            connection_updater();
        }
        displayer();
    };

    function updater() {
        const num = 0;
        const pro = "name";
        boxes[num][pro] = "Natootoki";
    }

    function splitStringToArray(inputString) {
        return inputString.split(',').map(item => item.trim());
    }

    function arrayToString(inputArray) {
        return inputArray.join(', ');
    }

    function removeDuplicates(inputArray) {
        return [...new Set(inputArray)];
    }

    function findIndexOfKeyword(array, keyword) {
        return array.findIndex(item => item.includes(keyword));
    }

    function findIndexOfId(array, id) {
        return array.findIndex(item => item.id === id);
    }

    function connection_updater() {
        let connection_array = splitStringToArray(boxes[lastClickedIndex][lastClickedKey]);
        let box_id_list = [];
        let update_add_index = [];
        let update_delete_index = [];
        update_add.forEach((connection) => {
            update_add_index.push(findIndexOfId(boxes, connection));
        });

        update_delete.forEach((connection) => {
            update_delete_index.push(findIndexOfId(boxes, connection));
        });
        boxes.forEach((box) => {
            box_id_list.push(box["id"]);
            update_add_index.forEach((connection) => {
                // console.log(boxes[connection]["name"]);
                // console.log(box["name"] === boxes[connection]["name"]);
                if (connection !== -1){
                    if (box["name"] === boxes[connection]["name"]) {
                        let target = "";
                        if (lastClickedKey === "successor") {
                            target = "predecessor";
                        }else if (lastClickedKey === "predecessor") {
                            target = "successor"
                        }
                        if (box[target] !== "") {
                            box[target] += ", ";
                        }
                        box[target] += boxes[lastClickedIndex]["id"];
                        box[target] = arrayToString(removeDuplicates(splitStringToArray(box[target])));
                    }
                }
            });
            update_delete_index.forEach((connection) => {
                if (connection !== -1){
                    if (box["name"] === boxes[connection]["name"]) {
                        let target = "";
                        if (lastClickedKey === "successor") {
                            target = "predecessor";
                        }else if (lastClickedKey === "predecessor") {
                            target = "successor"
                        }
                        let target_box_id = findIndexOfKeyword(splitStringToArray(box[target]), boxes[lastClickedIndex]["id"]);
                        let splice_array = splitStringToArray(box[target]);
                        splice_array.splice(target_box_id, 1);
                        box[target] = arrayToString(splice_array);
                        console.log(box[target])
                    }
                }

            });
            // console.log(box_id_list);
        });
    }

    function compareArrays(arrayA, arrayB) {
        update_add = [];
        update_delete = [];

        // 配列Bに追加された要素を探す
        arrayB.forEach(item => {
            if (!arrayA.includes(item)) {
                update_add.push(item);
            }
        });

        // 配列Aから削除された要素を探す
        arrayA.forEach(item => {
            if (!arrayB.includes(item)) {
                update_delete.push(item);
            }
        });
    }

    function update_detector() {
        compareArrays(splitStringToArray(boxes[lastClickedIndex][lastClickedKey]), splitStringToArray(inputField.value))
        console.log("add:"+update_add);
        console.log("delete:"+update_delete);
    }

    function drawRectangle(x, y, width, height) {
        const square = document.createElement('div'); // 新しい<div>要素を作成
        square.className = 'square'; // クラス名を設定
        square.style.left = `${x}px`; // X座標を設定
        square.style.top = `${y}px`; // Y座標を設定
        square.style.width = `${width}px`; // 幅を設定
        square.style.height = `${height}px`; // 高さを設定

        document.getElementById('rectangle').appendChild(square); // id="rectangle"の配下に追加
    }

    function drawLine(startX, startY, endX, endY) {
        const line = document.createElement('div'); // 新しい<div>要素を作成
        line.className = 'line'; // クラス名を設定

        // 線の長さを計算
        const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
        line.style.width = `${length}px`; // 線の幅を設定

        // 線の位置を設定
        line.style.left = `${startX}px`;
        line.style.top = `${startY}px`;

        // 線の角度を計算して回転
        const angle = Math.atan2(endY - startY, endX - startX) * (180 / Math.PI);
        line.style.transform = `rotate(${angle}deg)`; // 線を回転させる

        document.getElementById('rectangle').appendChild(line); // id="rectangle"の配下に追加
    }

    let rectangle_start_x = 32;
    let rectangle_start_y = 32;
    let rectangle_w = 32;
    let rectangle_h = 32;
    let rectangle_interval_w = 64;
    let rectangle_interval_h = 64;

    let arrow_start_x = rectangle_start_x + rectangle_w/2;
    let arrow_start_y = rectangle_start_y + rectangle_h/2;
    let arrow_interval_w = rectangle_w + rectangle_interval_w;
    let arrow_interval_h = rectangle_h + rectangle_interval_h;

    let rectangle_num = []
    // rectangle_num.push({x:0, y:0});
    // rectangle_num.push({x:1, y:0});
    // rectangle_num.push({x:2, y:0});
    // rectangle_num.push({x:3, y:0});
    // rectangle_num.push({x:4, y:0});

    let arrow_num = []
    // arrow_num.push({from:0, to:1});
    // arrow_num.push({from:1, to:2});

    // 使用例
    // drawLine(50, 50, 200, 200); // (始点X, 始点Y, 終点X, 終点Y)
    // drawLine(100, 300, 300, 100); // 別の直線

    // 使用例
    // drawRectangle(rectangle_start_x, rectangle_start_y, rectangle_start_w, rectangle_start_h); // (x, y, 幅, 高さ)

    function clearRectangle() {
        const rectangle = document.getElementById('rectangle');
        rectangle.innerHTML = ''; // 中身を空にする
        rectangle_num = [];
        arrow_num = [];
    }

    function diagram_displayer() {

        clearRectangle();

        boxes.forEach((item, index) => {
            rectangle_num.push({x:index, y:index**2/10});
            splitStringToArray(item.successor).forEach((arrow_item, arrow_index) => {
                if (arrow_item.length !== 0) {
                    arrow_num.push({from:index, to:Number(arrow_item)})
                }
            })
        });
        console.log(arrow_num);

        arrow_num.forEach((item, index) => {
            drawLine(
                arrow_start_x + arrow_interval_w * rectangle_num[item.from].x,
                arrow_start_y + arrow_interval_h * rectangle_num[item.from].y,
                arrow_start_x + arrow_interval_w * rectangle_num[item.to].x,
                arrow_start_y + arrow_interval_h * rectangle_num[item.to].y
            );
            console.log("hello");
        });

        rectangle_num.forEach((item, index) => {
            drawRectangle(
                rectangle_start_x + (rectangle_w + rectangle_interval_w) * item.x,
                rectangle_start_y + (rectangle_h + rectangle_interval_h) * item.y,
                rectangle_w,
                rectangle_h
            ); // (x, y, 幅, 高さ)
        });
    }

    function hoge() {
        console.log("hoge");
    }
</script>
</html>